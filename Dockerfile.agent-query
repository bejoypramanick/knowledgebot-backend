# Dockerfile.agent-query
# Agent Query Handler Microservice
# Handles intelligent query processing with production error handling

FROM public.ecr.aws/lambda/python:3.12

# Set environment variables for optimization
ENV PIP_DISABLE_PIP_VERSION_CHECK=1
ENV PIP_NO_CACHE_DIR=1
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN dnf update -y && \
    dnf install -y \
    gcc \
    gcc-c++ \
    make \
    && dnf clean all

# Copy requirements and install Python dependencies
COPY requirements-intelligent-agent.txt ${LAMBDA_TASK_ROOT}/
RUN pip install --no-cache-dir -r requirements-intelligent-agent.txt

# Copy application code
COPY microservices/agent-query-handler.py ${LAMBDA_TASK_ROOT}/lambda_function.py
COPY utils/production_error_handler.py ${LAMBDA_TASK_ROOT}/utils/
COPY utils/cors_helper.py ${LAMBDA_TASK_ROOT}/utils/

# Create necessary directories
RUN mkdir -p /tmp/agent /tmp/utils

# Set proper permissions
RUN chmod 755 ${LAMBDA_TASK_ROOT}/lambda_function.py
RUN chmod 755 ${LAMBDA_TASK_ROOT}/utils/*.py

CMD ["lambda_function.lambda_handler"]
