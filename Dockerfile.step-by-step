FROM public.ecr.aws/lambda/python:3.10

# Install basic system dependencies
RUN yum update -y && \
    yum install -y \
    gcc \
    gcc-c++ \
    make \
    python3-devel \
    && yum clean all

# Install basic Python packages
RUN pip install --upgrade pip setuptools wheel

# Test 1: Basic packages
RUN pip install --no-cache-dir numpy==1.26.4
RUN python -c "import numpy; print('NumPy works')"

# Test 2: AWS packages
RUN pip install --no-cache-dir boto3==1.34.0
RUN python -c "import boto3; print('Boto3 works')"

# Test 3: OpenAI
RUN pip install --no-cache-dir openai==1.12.0
RUN python -c "import openai; print('OpenAI works')"

# Test 4: PyTorch
RUN pip install --no-cache-dir torch==2.1.0
RUN python -c "import torch; print('PyTorch works')"

# Test 5: Transformers
RUN pip install --no-cache-dir transformers==4.36.0
RUN python -c "import transformers; print('Transformers works')"

# Test 6: Sentence Transformers
RUN pip install --no-cache-dir sentence-transformers==2.2.2
RUN python -c "import sentence_transformers; print('Sentence Transformers works')"

# Test 7: TensorFlow
RUN pip install --no-cache-dir tensorflow==2.20.0
RUN python -c "import tensorflow; print('TensorFlow works')"

# Test 8: Docling
RUN pip install --no-cache-dir docling==1.3.0
RUN python -c "import docling; print('Docling works')"

# If we get here, all packages work
RUN echo "All packages installed successfully!"

# Copy minimal code
COPY agent-toolkit/lambda_handlers.py ${LAMBDA_TASK_ROOT}/

# Set the CMD
CMD ["lambda_handlers.lambda_handler_knowledge_chat"]
