name: Deploy KnowledgeBot Backend - Clean MCP Architecture

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  AWS_REGION: ap-south-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com

jobs:
  # Build and push Docker images for MCP servers in parallel
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: chatbot
    strategy:
      matrix:
        include:
          - name: docling
            dockerfile: Dockerfile.docling-library
            image: knowledgebot-docling-mcp
          - name: pinecone-mcp
            dockerfile: Dockerfile.pinecone-mcp
            image: knowledgebot-pinecone-mcp
          - name: dynamodb-mcp
            dockerfile: Dockerfile.dynamodb-mcp
            image: knowledgebot-dynamodb-mcp
          - name: neo4j-cypher-mcp
            dockerfile: Dockerfile.neo4j-cypher-mcp
            image: knowledgebot-neo4j-cypher-mcp
          - name: neo4j-modeling-mcp
            dockerfile: Dockerfile.neo4j-data-modeling-mcp
            image: knowledgebot-neo4j-modeling-mcp
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Create ECR repositories
      run: |
        # Create ECR repositories for MCP servers only
        aws ecr create-repository --repository-name knowledgebot-docling-mcp --region ${{ env.AWS_REGION }} || echo "Repository already exists"
        aws ecr create-repository --repository-name knowledgebot-pinecone-mcp --region ${{ env.AWS_REGION }} || echo "Repository already exists"
        aws ecr create-repository --repository-name knowledgebot-dynamodb-mcp --region ${{ env.AWS_REGION }} || echo "Repository already exists"
        aws ecr create-repository --repository-name knowledgebot-neo4j-cypher-mcp --region ${{ env.AWS_REGION }} || echo "Repository already exists"
        aws ecr create-repository --repository-name knowledgebot-neo4j-modeling-mcp --region ${{ env.AWS_REGION }} || echo "Repository already exists"
        
        # Set lifecycle policy to keep only latest 10 images
        aws ecr put-lifecycle-policy --repository-name knowledgebot-docling-mcp --lifecycle-policy-text '{"rules":[{"rulePriority":1,"description":"Keep last 10 images","selection":{"tagStatus":"any","countType":"imageCountMoreThan","countNumber":10},"action":{"type":"expire"}}]}' --region ${{ env.AWS_REGION }} || echo "Lifecycle policy already set"
        aws ecr put-lifecycle-policy --repository-name knowledgebot-pinecone-mcp --lifecycle-policy-text '{"rules":[{"rulePriority":1,"description":"Keep last 10 images","selection":{"tagStatus":"any","countType":"imageCountMoreThan","countNumber":10},"action":{"type":"expire"}}]}' --region ${{ env.AWS_REGION }} || echo "Lifecycle policy already set"
        aws ecr put-lifecycle-policy --repository-name knowledgebot-dynamodb-mcp --lifecycle-policy-text '{"rules":[{"rulePriority":1,"description":"Keep last 10 images","selection":{"tagStatus":"any","countType":"imageCountMoreThan","countNumber":10},"action":{"type":"expire"}}]}' --region ${{ env.AWS_REGION }} || echo "Lifecycle policy already set"
        aws ecr put-lifecycle-policy --repository-name knowledgebot-neo4j-cypher-mcp --lifecycle-policy-text '{"rules":[{"rulePriority":1,"description":"Keep last 10 images","selection":{"tagStatus":"any","countType":"imageCountMoreThan","countNumber":10},"action":{"type":"expire"}}]}' --region ${{ env.AWS_REGION }} || echo "Lifecycle policy already set"
        aws ecr put-lifecycle-policy --repository-name knowledgebot-neo4j-modeling-mcp --lifecycle-policy-text '{"rules":[{"rulePriority":1,"description":"Keep last 10 images","selection":{"tagStatus":"any","countType":"imageCountMoreThan","countNumber":10},"action":{"type":"expire"}}]}' --region ${{ env.AWS_REGION }} || echo "Lifecycle policy already set"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push ${{ matrix.name }} MCP server image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./${{ matrix.dockerfile }}
        push: true
        tags: |
          ${{ env.ECR_REGISTRY }}/${{ matrix.image }}:${{ github.sha }}
          ${{ env.ECR_REGISTRY }}/${{ matrix.image }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Deploy MCP servers as Lambda functions
  deploy-mcp-servers:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: chatbot
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Create IAM role for Lambda execution
      run: |
        # Create IAM role for Lambda execution
        aws iam create-role \
          --role-name mcp-lambda-execution-role \
          --assume-role-policy-document '{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "lambda.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }' || echo "Role already exists"
        
        # Attach basic execution policy
        aws iam attach-role-policy \
          --role-name mcp-lambda-execution-role \
          --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole || echo "Policy already attached"

    - name: Deploy MCP server Lambda functions
      run: |
        # Deploy Docling MCP server
        aws lambda update-function-code \
          --function-name docling-mcp-server \
          --image-uri ${{ env.ECR_REGISTRY }}/knowledgebot-docling-mcp:${{ github.sha }} \
          --region ${{ env.AWS_REGION }} || \
        aws lambda create-function \
          --function-name docling-mcp-server \
          --package-type Image \
          --code ImageUri=${{ env.ECR_REGISTRY }}/knowledgebot-docling-mcp:${{ github.sha }} \
          --role arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/mcp-lambda-execution-role \
          --timeout 900 \
          --memory-size 2048 \
          --region ${{ env.AWS_REGION }}

        # Deploy Pinecone MCP server
        aws lambda update-function-code \
          --function-name pinecone-mcp-server \
          --image-uri ${{ env.ECR_REGISTRY }}/knowledgebot-pinecone-mcp:${{ github.sha }} \
          --region ${{ env.AWS_REGION }} || \
        aws lambda create-function \
          --function-name pinecone-mcp-server \
          --package-type Image \
          --code ImageUri=${{ env.ECR_REGISTRY }}/knowledgebot-pinecone-mcp:${{ github.sha }} \
          --role arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/mcp-lambda-execution-role \
          --timeout 900 \
          --memory-size 1024 \
          --region ${{ env.AWS_REGION }}

        # Deploy DynamoDB MCP server
        aws lambda update-function-code \
          --function-name dynamodb-mcp-server \
          --image-uri ${{ env.ECR_REGISTRY }}/knowledgebot-dynamodb-mcp:${{ github.sha }} \
          --region ${{ env.AWS_REGION }} || \
        aws lambda create-function \
          --function-name dynamodb-mcp-server \
          --package-type Image \
          --code ImageUri=${{ env.ECR_REGISTRY }}/knowledgebot-dynamodb-mcp:${{ github.sha }} \
          --role arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/mcp-lambda-execution-role \
          --timeout 900 \
          --memory-size 1024 \
          --region ${{ env.AWS_REGION }}

        # Deploy Neo4j Cypher MCP server
        aws lambda update-function-code \
          --function-name neo4j-cypher-mcp-server \
          --image-uri ${{ env.ECR_REGISTRY }}/knowledgebot-neo4j-cypher-mcp:${{ github.sha }} \
          --region ${{ env.AWS_REGION }} || \
        aws lambda create-function \
          --function-name neo4j-cypher-mcp-server \
          --package-type Image \
          --code ImageUri=${{ env.ECR_REGISTRY }}/knowledgebot-neo4j-cypher-mcp:${{ github.sha }} \
          --role arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/mcp-lambda-execution-role \
          --timeout 900 \
          --memory-size 1024 \
          --region ${{ env.AWS_REGION }}

        # Deploy Neo4j Data Modeling MCP server
        aws lambda update-function-code \
          --function-name neo4j-modeling-mcp-server \
          --image-uri ${{ env.ECR_REGISTRY }}/knowledgebot-neo4j-modeling-mcp:${{ github.sha }} \
          --region ${{ env.AWS_REGION }} || \
        aws lambda create-function \
          --function-name neo4j-modeling-mcp-server \
          --package-type Image \
          --code ImageUri=${{ env.ECR_REGISTRY }}/knowledgebot-neo4j-modeling-mcp:${{ github.sha }} \
          --role arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/mcp-lambda-execution-role \
          --timeout 900 \
          --memory-size 1024 \
          --region ${{ env.AWS_REGION }}

    - name: Create Function URLs for MCP servers
      run: |
        # Create Function URLs for all MCP servers
        for function_name in docling-mcp-server pinecone-mcp-server dynamodb-mcp-server neo4j-cypher-mcp-server neo4j-modeling-mcp-server; do
          aws lambda create-function-url-config \
            --function-name $function_name \
            --auth-type NONE \
            --region ${{ env.AWS_REGION }} || \
          aws lambda update-function-url-config \
            --function-name $function_name \
            --auth-type NONE \
            --region ${{ env.AWS_REGION }}
        done

    - name: Update MCP server environment variables
      run: |
        # Update Docling MCP server environment variables
        aws lambda update-function-configuration \
          --function-name docling-mcp-server \
          --environment Variables='{
            "AWS_REGION":"${{ env.AWS_REGION }}"
          }' \
          --region ${{ env.AWS_REGION }}

        # Update Pinecone MCP server environment variables
        aws lambda update-function-configuration \
          --function-name pinecone-mcp-server \
          --environment Variables='{
            "PINECONE_API_KEY":"${{ secrets.PINECONE_API_KEY }}",
            "PINECONE_ENVIRONMENT":"${{ secrets.PINECONE_ENVIRONMENT }}",
            "AWS_REGION":"${{ env.AWS_REGION }}"
          }' \
          --region ${{ env.AWS_REGION }}

        # Update DynamoDB MCP server environment variables
        aws lambda update-function-configuration \
          --function-name dynamodb-mcp-server \
          --environment Variables='{
            "AWS_ACCESS_KEY_ID":"${{ secrets.AWS_ACCESS_KEY_ID }}",
            "AWS_SECRET_ACCESS_KEY":"${{ secrets.AWS_SECRET_ACCESS_KEY }}",
            "AWS_REGION":"${{ env.AWS_REGION }}"
          }' \
          --region ${{ env.AWS_REGION }}

        # Update Neo4j Cypher MCP server environment variables
        aws lambda update-function-configuration \
          --function-name neo4j-cypher-mcp-server \
          --environment Variables='{
            "NEO4J_URI":"${{ secrets.NEO4J_URI }}",
            "NEO4J_USERNAME":"${{ secrets.NEO4J_USERNAME }}",
            "NEO4J_PASSWORD":"${{ secrets.NEO4J_PASSWORD }}",
            "NEO4J_DATABASE":"${{ secrets.NEO4J_DATABASE }}",
            "AWS_REGION":"${{ env.AWS_REGION }}"
          }' \
          --region ${{ env.AWS_REGION }}

        # Update Neo4j Data Modeling MCP server environment variables
        aws lambda update-function-configuration \
          --function-name neo4j-modeling-mcp-server \
          --environment Variables='{
            "NEO4J_URI":"${{ secrets.NEO4J_URI }}",
            "NEO4J_USERNAME":"${{ secrets.NEO4J_USERNAME }}",
            "NEO4J_PASSWORD":"${{ secrets.NEO4J_PASSWORD }}",
            "NEO4J_DATABASE":"${{ secrets.NEO4J_DATABASE }}",
            "AWS_REGION":"${{ env.AWS_REGION }}"
          }' \
          --region ${{ env.AWS_REGION }}

  # Clean up redundant AWS resources
  cleanup-redundant-resources:
    runs-on: ubuntu-latest
    needs: deploy-mcp-servers
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: chatbot
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Delete redundant Lambda functions
      run: |
        # List of redundant Lambda functions to delete
        REDUNDANT_FUNCTIONS=(
          "openai-agents-handler"
          "dynamodb-mcp-handler"
          "chat-orchestrator-websocket"
          "document-processor-business-logic"
          "s3-unified-handler"
          "error-logger-handler"
          "error-query-handler"
          "docling-library-handler"
          "pinecone-library-handler"
          "neo4j-library-handler"
          "dynamodb-crud-handler"
          "neo4j-mcp-server"
        )
        
        for function_name in "${REDUNDANT_FUNCTIONS[@]}"; do
          echo "Deleting Lambda function: $function_name"
          aws lambda delete-function \
            --function-name $function_name \
            --region ${{ env.AWS_REGION }} || echo "Function $function_name not found or already deleted"
        done

    - name: Delete redundant DynamoDB tables
      run: |
        # List of redundant DynamoDB tables to delete
        REDUNDANT_TABLES=(
          "document-chunks-staging"
          "document-chunks-production"
          "knowledgebot-error-logs-staging"
          "knowledgebot-error-logs-production"
        )
        
        for table_name in "${REDUNDANT_TABLES[@]}"; do
          echo "Deleting DynamoDB table: $table_name"
          aws dynamodb delete-table \
            --table-name $table_name \
            --region ${{ env.AWS_REGION }} || echo "Table $table_name not found or already deleted"
        done

    - name: Delete redundant S3 buckets
      run: |
        # List of redundant S3 buckets to delete
        REDUNDANT_BUCKETS=(
          "knowledgebot-documents-staging"
          "knowledgebot-documents-production"
          "processed-documents-staging"
          "processed-documents-production"
          "knowledgebot-error-logs-staging"
          "knowledgebot-error-logs-production"
        )
        
        for bucket_name in "${REDUNDANT_BUCKETS[@]}"; do
          echo "Deleting S3 bucket: $bucket_name"
          # First, empty the bucket
          aws s3 rm s3://$bucket_name --recursive || echo "Bucket $bucket_name is empty or doesn't exist"
          # Then delete the bucket
          aws s3 rb s3://$bucket_name --region ${{ env.AWS_REGION }} || echo "Bucket $bucket_name not found or already deleted"
        done

    - name: Delete redundant IAM roles
      run: |
        # Delete redundant IAM roles
        REDUNDANT_ROLES=(
          "lambda-execution-role"
        )
        
        for role_name in "${REDUNDANT_ROLES[@]}"; do
          echo "Deleting IAM role: $role_name"
          # First, detach all policies
          aws iam list-attached-role-policies --role-name $role_name --query 'AttachedPolicies[].PolicyArn' --output text | \
          xargs -I {} aws iam detach-role-policy --role-name $role_name --policy-arn {} || echo "No policies attached to $role_name"
          # Then delete the role
          aws iam delete-role --role-name $role_name || echo "Role $role_name not found or already deleted"
        done

  # Notify deployment status
  notify:
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-mcp-servers, cleanup-redundant-resources]
    if: always()
    environment: chatbot
    
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.deploy-mcp-servers.result }}" == "success" ]; then
          echo "✅ MCP servers deployed successfully!"
          echo "Available MCP servers:"
          echo "- Docling MCP Server"
          echo "- Pinecone MCP Server" 
          echo "- DynamoDB MCP Server"
          echo "- Neo4j Cypher MCP Server"
          echo "- Neo4j Data Modeling MCP Server"
          echo ""
          echo "All redundant AWS resources have been cleaned up."
        else
          echo "❌ Deployment failed!"
          exit 1
        fi
