name: Deploy All Lambda Functions

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: knowledgebot-lambdas

jobs:
  build-docker-images:
    runs-on: ubuntu-latest
    environment: chatbot
    strategy:
      matrix:
        include:
          - handler: docling-library
            function: docling-library-handler
          - handler: pinecone-library
            function: pinecone-library-handler
          - handler: neo4j-library
            function: neo4j-library-handler
          - handler: openai-library
            function: openai-library-handler
          - handler: sentence-transformer-library
            function: sentence-transformer-library-handler
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push Docker image
      run: |
        # Get account ID
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        
        echo "üèóÔ∏è Building ${{ matrix.handler }}..."
        
        # Build image
        docker build -f Dockerfile.${{ matrix.handler }} -t ${{ matrix.handler }} .
        
        # Tag for ECR
        docker tag ${{ matrix.handler }}:latest $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:${{ matrix.handler }}-latest
        
        # Push to ECR
        docker push $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:${{ matrix.handler }}-latest
        
        echo "‚úÖ ${{ matrix.handler }} pushed successfully"

    - name: Deploy Lambda function
      run: |
        # Get account ID
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        
        echo "üöÄ Deploying ${{ matrix.function }}..."
        
        # Check if function exists
        if aws lambda get-function --function-name ${{ matrix.function }} --region $AWS_REGION >/dev/null 2>&1; then
          # Update existing function
          aws lambda update-function-code \
            --function-name ${{ matrix.function }} \
            --image-uri $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:${{ matrix.handler }}-latest \
            --region $AWS_REGION
          echo "‚úÖ ${{ matrix.function }} updated successfully"
        else
          # Create new function
          aws lambda create-function \
            --function-name ${{ matrix.function }} \
            --package-type Image \
            --code ImageUri=$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:${{ matrix.handler }}-latest \
            --role arn:aws:iam::$ACCOUNT_ID:role/lambda-execution-role \
            --timeout 900 \
            --memory-size 3008 \
            --region $AWS_REGION
          echo "‚úÖ ${{ matrix.function }} created successfully"
        fi

  deploy-zip-lambdas:
    needs: build-docker-images
    runs-on: ubuntu-latest
    environment: chatbot
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Deploy business logic Lambda functions
      run: |
        # Get account ID
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        
        # Business logic handlers to deploy
        declare -a BUSINESS_HANDLERS=(
          "document-processor-business-logic"
          "chat-orchestrator-business-logic"
          "dynamodb-crud-handler"
          "s3-unified-handler"
        )
        
        for handler in "${BUSINESS_HANDLERS[@]}"; do
          echo "Creating deployment package for $handler..."
          
          # Create temporary directory
          TEMP_DIR=$(mktemp -d)
          cd $TEMP_DIR
          
          # Copy handler file
          cp ../microservices/$handler.py .
          
          # Install minimal dependencies for business logic
          pip install -r ../requirements-zip-lambdas.txt -t . --quiet
          
          # Create zip package
          zip -r $handler.zip . >/dev/null
          
          echo "Deploying Lambda function: $handler"
          
          # Check if function exists
          if aws lambda get-function --function-name $handler --region $AWS_REGION >/dev/null 2>&1; then
            # Update existing function
            aws lambda update-function-code \
              --function-name $handler \
              --zip-file fileb://$handler.zip \
              --region $AWS_REGION
            echo "‚úÖ $handler updated successfully"
          else
            # Create new function
            aws lambda create-function \
              --function-name $handler \
              --runtime python3.11 \
              --role arn:aws:iam::$ACCOUNT_ID:role/lambda-execution-role \
              --handler $handler.lambda_handler \
              --zip-file fileb://$handler.zip \
              --timeout 900 \
              --memory-size 512 \
              --region $AWS_REGION
            echo "‚úÖ $handler created successfully"
          fi
          
          # Clean up
          cd -
          rm -rf $TEMP_DIR
        done

    - name: Set environment variables for business logic functions
      run: |
        # Set environment variables for business logic functions to know which library functions to call
        declare -a BUSINESS_HANDLERS=(
          "document-processor-business-logic"
          "chat-orchestrator-business-logic"
        )
        
        for handler in "${BUSINESS_HANDLERS[@]}"; do
          echo "Setting environment variables for $handler..."
          
          aws lambda update-function-configuration \
            --function-name $handler \
            --environment Variables="{
              DOCLING_LIBRARY_FUNCTION=docling-library-handler,
              PINECONE_LIBRARY_FUNCTION=pinecone-library-handler,
              NEO4J_LIBRARY_FUNCTION=neo4j-library-handler,
              OPENAI_LIBRARY_FUNCTION=openai-library-handler,
              SENTENCE_TRANSFORMER_LIBRARY_FUNCTION=sentence-transformer-library-handler,
              CHUNKS_TABLE=document-chunks,
              PROCESSED_DOCUMENTS_BUCKET=processed-documents
            }" \
            --region $AWS_REGION || true
        done

  summary:
    needs: [build-docker-images, deploy-zip-lambdas]
    runs-on: ubuntu-latest
    environment: chatbot
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "üéâ Lambda Deployment Summary"
        echo "================================"
        echo ""
        echo "Docker Lambdas (Library Installations):"
        echo "  ‚úÖ docling-library-handler"
        echo "  ‚úÖ pinecone-library-handler"
        echo "  ‚úÖ neo4j-library-handler"
        echo "  ‚úÖ openai-library-handler"
        echo "  ‚úÖ sentence-transformer-library-handler"
        echo ""
        echo "Zip Lambdas (Business Logic - Viewable in AWS Console):"
        echo "  ‚úÖ document-processor-business-logic"
        echo "  ‚úÖ chat-orchestrator-business-logic"
        echo "  ‚úÖ dynamodb-crud-handler"
        echo "  ‚úÖ s3-unified-handler"
        echo ""
        echo "üí° All business logic code is now viewable in AWS Lambda console!"
        echo "üîß Library installations are handled by Docker Lambdas"
        echo "üìù All CRUD operations happen in Zip Lambdas"
