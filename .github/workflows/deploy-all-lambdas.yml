name: Deploy All Lambda Functions

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: knowledgebot-lambdas

jobs:
  deploy-docker-lambdas:
    runs-on: ubuntu-latest
    environment: chatbot
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug AWS Configuration
      run: |
        echo "üîç Debugging AWS Configuration..."
        echo "AWS_REGION: ${{ secrets.AWS_REGION }}"
        echo "AWS_ACCESS_KEY_ID length: ${#AWS_ACCESS_KEY_ID}"
        echo "AWS_SECRET_ACCESS_KEY length: ${#AWS_SECRET_ACCESS_KEY}"
        echo "ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push Docker images
      run: |
        # Get account ID
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        
        # Library handlers to build
        declare -a LIBRARY_HANDLERS=(
          "docling-library"
          "pinecone-library" 
          "neo4j-library"
          "openai-library"
          "sentence-transformer-library"
        )
        
        for handler in "${LIBRARY_HANDLERS[@]}"; do
          echo "Building and pushing $handler..."
          
          # Build image
          docker build -f Dockerfile.$handler -t $handler .
          
          # Tag for ECR
          docker tag $handler:latest $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$handler-latest
          
          # Push to ECR
          docker push $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$handler-latest
          
          echo "‚úÖ $handler pushed successfully"
        done

    - name: Deploy Lambda functions
      run: |
        # Get account ID
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        
        # Library handlers to deploy
        declare -a LIBRARY_HANDLERS=(
          "docling-library-handler"
          "pinecone-library-handler" 
          "neo4j-library-handler"
          "openai-library-handler"
          "sentence-transformer-library-handler"
        )
        
        for handler in "${LIBRARY_HANDLERS[@]}"; do
          echo "Deploying Lambda function: $handler"
          
          # Check if function exists
          if aws lambda get-function --function-name $handler --region $AWS_REGION >/dev/null 2>&1; then
            # Update existing function
            aws lambda update-function-code \
              --function-name $handler \
              --image-uri $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:${handler%-handler}-library-latest \
              --region $AWS_REGION
            echo "‚úÖ $handler updated successfully"
          else
            # Create new function
            aws lambda create-function \
              --function-name $handler \
              --package-type Image \
              --code ImageUri=$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:${handler%-handler}-library-latest \
              --role arn:aws:iam::$ACCOUNT_ID:role/lambda-execution-role \
              --timeout 900 \
              --memory-size 3008 \
              --region $AWS_REGION
            echo "‚úÖ $handler created successfully"
          fi
        done

  deploy-zip-lambdas:
    needs: deploy-docker-lambdas
    runs-on: ubuntu-latest
    environment: chatbot
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Deploy business logic Lambda functions
      run: |
        # Get account ID
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        
        # Business logic handlers to deploy
        declare -a BUSINESS_HANDLERS=(
          "document-processor-business-logic"
          "chat-orchestrator-business-logic"
          "dynamodb-crud-handler"
          "s3-unified-handler"
        )
        
        for handler in "${BUSINESS_HANDLERS[@]}"; do
          echo "Creating deployment package for $handler..."
          
          # Create temporary directory
          TEMP_DIR=$(mktemp -d)
          cd $TEMP_DIR
          
          # Copy handler file
          cp ../microservices/$handler.py .
          
          # Install minimal dependencies for business logic
          pip install -r ../requirements-zip-lambdas.txt -t . --quiet
          
          # Create zip package
          zip -r $handler.zip . >/dev/null
          
          echo "Deploying Lambda function: $handler"
          
          # Check if function exists
          if aws lambda get-function --function-name $handler --region $AWS_REGION >/dev/null 2>&1; then
            # Update existing function
            aws lambda update-function-code \
              --function-name $handler \
              --zip-file fileb://$handler.zip \
              --region $AWS_REGION
            echo "‚úÖ $handler updated successfully"
          else
            # Create new function
            aws lambda create-function \
              --function-name $handler \
              --runtime python3.11 \
              --role arn:aws:iam::$ACCOUNT_ID:role/lambda-execution-role \
              --handler $handler.lambda_handler \
              --zip-file fileb://$handler.zip \
              --timeout 900 \
              --memory-size 512 \
              --region $AWS_REGION
            echo "‚úÖ $handler created successfully"
          fi
          
          # Clean up
          cd -
          rm -rf $TEMP_DIR
        done

    - name: Set environment variables for business logic functions
      run: |
        # Set environment variables for business logic functions to know which library functions to call
        declare -a BUSINESS_HANDLERS=(
          "document-processor-business-logic"
          "chat-orchestrator-business-logic"
        )
        
        for handler in "${BUSINESS_HANDLERS[@]}"; do
          echo "Setting environment variables for $handler..."
          
          aws lambda update-function-configuration \
            --function-name $handler \
            --environment Variables="{
              DOCLING_LIBRARY_FUNCTION=docling-library-handler,
              PINECONE_LIBRARY_FUNCTION=pinecone-library-handler,
              NEO4J_LIBRARY_FUNCTION=neo4j-library-handler,
              OPENAI_LIBRARY_FUNCTION=openai-library-handler,
              SENTENCE_TRANSFORMER_LIBRARY_FUNCTION=sentence-transformer-library-handler,
              CHUNKS_TABLE=document-chunks,
              PROCESSED_DOCUMENTS_BUCKET=processed-documents
            }" \
            --region $AWS_REGION || true
        done

  summary:
    needs: [deploy-docker-lambdas, deploy-zip-lambdas]
    runs-on: ubuntu-latest
    environment: chatbot
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "üéâ Lambda Deployment Summary"
        echo "================================"
        echo ""
        echo "Docker Lambdas (Library Installations):"
        echo "  ‚úÖ docling-library-handler"
        echo "  ‚úÖ pinecone-library-handler"
        echo "  ‚úÖ neo4j-library-handler"
        echo "  ‚úÖ openai-library-handler"
        echo "  ‚úÖ sentence-transformer-library-handler"
        echo ""
        echo "Zip Lambdas (Business Logic - Viewable in AWS Console):"
        echo "  ‚úÖ document-processor-business-logic"
        echo "  ‚úÖ chat-orchestrator-business-logic"
        echo "  ‚úÖ dynamodb-crud-handler"
        echo "  ‚úÖ s3-unified-handler"
        echo ""
        echo "üí° All business logic code is now viewable in AWS Lambda console!"
        echo "üîß Library installations are handled by Docker Lambdas"
        echo "üìù All CRUD operations happen in Zip Lambdas"
